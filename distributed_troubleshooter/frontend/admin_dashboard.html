<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

  <div class="container mt-5">
    <h2 class="text-center mb-4">Admin Panel - Expert Verification</h2>

    <div class="text-center mb-3">
      <button class="btn btn-primary" onclick="loadExperts()">Load Expert Submissions</button>
    </div>

    <div id="experts" class="mb-4"></div>

    <div class="card p-3 mt-4">
      <h4>📊 Region Stats</h4>
      <div id="region-stats" class="mt-3"></div>
    </div>

    <div class="card p-3 mt-4">
      <h4>📈 Live Load Per Region</h4>
      <canvas id="regionChart" height="200"></canvas>
    </div>

    <div class="card p-3 mt-4">
      <h4>🛰️ Issues Grouped by Region</h4>
      <div id="issues-by-region" class="mt-3"></div>
    </div>

    <div class="card p-3 mt-4">
      <h4>🔁 Rerouted Issues</h4>
      <div id="rerouted-issues" class="mt-3"></div>
    </div>


    <div class="text-center">
      <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const BASE_URL = "http://localhost:8000";

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }

    function loadExperts() {
      const token = localStorage.getItem("token");

      fetch(`${BASE_URL}/experts_unverified`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => displayExperts(data))
      .catch(() => {
        document.getElementById("experts").innerHTML = "<p class='text-danger'>Failed to load experts.</p>";
      });
    }

    function displayExperts(experts) {
      const container = document.getElementById("experts");
      container.innerHTML = "";

      if (!experts.length) {
        container.innerHTML = "<p class='text-muted text-center'>No pending experts found.</p>";
        return;
      }

      experts.forEach(expert => {
        const card = document.createElement("div");
        card.className = "card mb-3 p-3";

        card.innerHTML = `
          <h5>${expert.name}</h5>
          <p><strong>Email:</strong> ${expert.email}</p>
          <p><strong>Qualifications:</strong> ${expert.qualifications}</p>
          <p><strong>Experience:</strong> ${expert.experience_years} years</p>
          <p><strong>Quiz Score:</strong> ${expert.quiz_score}</p>
          <p><strong>Portfolio:</strong> <a href="${expert.portfolio_url}" target="_blank">${expert.portfolio_url}</a></p>
          <p><strong>Resume:</strong> ${expert.proof_resume}</p>
          <textarea id="note-${expert.expert_id}" class="form-control mb-2" placeholder="Verification notes (optional)"></textarea>
          <button class="btn btn-success" onclick="verifyExpert('${expert.expert_id}')">Verify</button>
        `;

        container.appendChild(card);
      });
    }

    function verifyExpert(expert_id) {
      const token = localStorage.getItem("token");
      const notes = document.getElementById(`note-${expert_id}`).value;

      fetch(`${BASE_URL}/admin/verify_expert/${expert_id}?notes=${encodeURIComponent(notes)}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(() => {
        alert("Expert verified.");
        loadExperts();
      })
      .catch(() => alert("Failed to verify expert."));
    }

    function loadRegionStats() {
      fetch(`${BASE_URL}/region_stats`, {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
      .then(res => res.json())
      .then(stats => {
        const div = document.getElementById("region-stats");
        div.innerHTML = "";
        for (const region in stats) {
          const s = stats[region];
          div.innerHTML += `<p><strong>${region.toUpperCase()}</strong>: 🛠️ ${s.active_issues} active | 👨‍💻 ${s.available_experts} available experts</p>`;
        }
      });
    }

    function loadIssuesByRegion() {
      fetch(`${BASE_URL}/all_issues_by_region`, {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
      .then(res => res.json())
      .then(grouped => {
        const div = document.getElementById("issues-by-region");
        div.innerHTML = "";

        if (typeof grouped !== 'object' || grouped === null) {
          div.innerHTML = "<p class='text-danger'>Invalid data received.</p>";
          return;
        }

        for (const region in grouped) {
          const issues = Array.isArray(grouped[region]) ? grouped[region] : [];
          div.innerHTML += `<h5 class="mt-3">${region.toUpperCase()} (${issues.length} issues)</h5>`;
          issues.forEach(issue => {
            div.innerHTML += `<div class="border rounded p-2 mb-2 bg-white">
              <strong>${issue.title}</strong> — ${issue.status} <br/>
              Assigned: ${issue.assigned_expert || "Not Assigned"}
            </div>`;
          });
        }
      })
      .catch(() => {
        document.getElementById("issues-by-region").innerHTML = "<p class='text-danger'>Failed to load issues.</p>";
      });
    }

    function loadReroutedIssues() {
      fetch(`${BASE_URL}/rerouted_issues`, {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
      .then(res => res.json())
      .then(data => {
        const div = document.getElementById("rerouted-issues");
        if (!data.length) {
          div.innerHTML = "<p class='text-muted'>No rerouted issues found.</p>";
          return;
        }
        div.innerHTML = "";
        data.forEach(issue => {
          let logEntries = issue.reassignment_log.map(r => {
            const ts = new Date(r.timestamp).toLocaleString();
            return `➡️ ${r.expert_id} (${ts})`;
          }).join("<br>");

          div.innerHTML += `<div class="border rounded p-2 mb-3 bg-white">
            <strong>${issue.title}</strong> — <code>${issue.issue_id}</code><br/>
            <small>Region: ${issue.region}</small><br/>
            ${logEntries}
          </div>`;
        });
      });
    }

    let regionChart;

    function drawRegionChart(stats) {
      const ctx = document.getElementById('regionChart').getContext('2d');
      const labels = Object.keys(stats).map(r => r.toUpperCase());
      const data = Object.values(stats).map(r => r.active_issues);

      if (regionChart) {
        regionChart.data.labels = labels;
        regionChart.data.datasets[0].data = data;
        regionChart.update();
      } else {
        regionChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Active Issues',
              data,
              backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true, stepSize: 1 }
            }
          }
        });
      }
    }

    function loadRegionStats() {
      fetch(`${BASE_URL}/region_stats`, {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
      .then(res => res.json())
      .then(stats => {
        const div = document.getElementById("region-stats");
        div.innerHTML = "";
        for (const region in stats) {
          const s = stats[region];
          div.innerHTML += `<p><strong>${region.toUpperCase()}</strong>: 🛠️ ${s.active_issues} active | 👨‍💻 ${s.available_experts} available experts</p>`;
        }
        drawRegionChart(stats);  // ✅ Update chart
      });
    }


    window.onload = () => {
      loadExperts();
      loadRegionStats();
      loadIssuesByRegion();
      loadReroutedIssues();  // ✅ new addition
    };

  </script>

</body>
</html>
